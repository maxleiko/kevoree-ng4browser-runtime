<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Kevoree Browser Installer frame</title>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.1/react.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.1/react-dom.min.js"></script>
  </head>
  <body>
    <script type="application/javascript">
    function notifyMain(error) {
      if (error) {
        parent.postMessage({ type: 'error', error: error.message }, window.location.origin);
      } else {
        parent.postMessage({ type: 'done' }, window.location.origin);
      }
    }

    window.onerror = (msg, url, line, col, err) => {
      notifyMain({
        type: 'error',
        error: err,
        message: msg,
        url: url,
        line: line,
        col: col
      });
    };

    function loadScript(du) {
      return new Promise(function (resolve, reject) {
        const script = document.createElement('script');
        script.setAttribute('src', `https://unpkg.com/${du.name}@${du.version}/browser/${du.name}.js`);
        script.async = true;
        script.onload = function () {
          console.log(`DeployUnit ${du.name}@${du.version} resolved successfully`);
          resolve();
        };
        document.body.appendChild(script);
      });
    }

    const params = decodeURI(window.location.search.substr(1))
      .split('&')
      .reduce((params, value) => {
        const array = value.split('=');
        params[array[0]] = array[1];
        return params;
      }, {});

    console.log(`Resolving https://unpkg.com/${params.name}@${params.version}/browser/${params.name}.js`);

    window.KevoreeLibrary = parent.KevoreeLibrary;
    window.KevoreeModuleLoader = parent.KevoreeModuleLoader;

    loadScript(params).then(notifyMain);
    </script>
  </body>
</html>
