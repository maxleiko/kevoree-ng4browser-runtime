<html>

<head>
  <title>Installer frame</title>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/15.3.2/react.min.js"></script>
</head>

<body>
  <script type="application/javascript">
    if (window.parent === window) {
      window.location.replace(window.location.origin);
    }

    function loadScript(srcPath) {
      return new Promise(function (resolve, reject) {
        const script = document.createElement('script');
        script.setAttribute('src', srcPath);
        script.async = true;
        script.onload = function () {
          document.body.removeChild(script);
          resolve();
        };
        script.onerror = function () {
          document.body.removeChild(script);
          reject(new Error('Unable to load script ' + srcPath));
        };
        document.body.appendChild(script);
      });
    }

    function installDeployUnit(resolver, name, version, devMode) {
      if (devMode === 'true') {
        return loadScript('http://localhost:59000/browser/'+name+'.js')
          .then(() => 'http://localhost:59000')
          .catch(() =>
            loadScript(resolver + '/' + name + '@' + version + '/browser/' + name + '.js')
              .catch(() => {
                return loadScript(resolver + '/' + name + '@' + version + '/build/browser/' + name + '.js');
              })
              .then(() => resolver));
      }

      return loadScript(resolver + '/' + name + '@' + version + '/browser/' + name + '.js')
        .catch(() => {
          return loadScript(resolver + '/' + name + '@' + version + '/build/browser/' + name + '.js');
        })
        .then(() => resolver);
    }

    var params = window.location.search
      .substr(1)
      .split('&')
      .reduce((obj, pair) => {
        const array = pair.split('=');
        obj[array[0]] = array[1];
        return obj;
      }, {});

    var KevoreeModuleLoader = parent.KevoreeModuleLoader;
    var KevoreeLibrary = parent.KevoreeLibrary;
    var scriptError = null;

    window.onerror = function (msg, url, line, col, err) {
      var msg = {
        type: 'error',
        error: err,
        message: msg,
        url: url,
        line: line,
        col: col
      };
      parent.postMessage(msg, window.location.origin);
      scriptError = msg;
    };

    console.log('Installing: ' + params.name + '@' + params.version);
    installDeployUnit(params.resolver, params.name, params.version, params.devMode)
      .then(function (resolver) {
        if (!scriptError) {
          console.log('Installed: ' + params.name + '@' + params.version);
          parent.postMessage({
            type: 'installed',
            name: params.name,
            version: params.version,
            resolver: resolver
          }, window.location.origin);
        }
      })
      .catch(function (err) {
        console.error('Something went wrong!');
        parent.postMessage({type: 'error', error: err }, window.location.origin);
      });
  </script>
</body>

</html>
